name: Tutor Setup with Plugin Verification

on: [push]

jobs:
  setup-tutor:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

#      - name: Set up Python 3.11
#        uses: actions/setup-python@v2
#        with:
#          python-version: '3.11'

      - name: Check open ports
        run: |
          sudo netstat -tuln  # Or use ss if netstat is not available

      - name: Check for web proxy services
        run: |
          ps aux | grep -E 'nginx|apache|caddy'

      - name: Check for proxy environment variables
        run: |
          env | grep -i proxy

      - name: Install Tutor
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install tutor

#      - name: Add extra LMS requirements
#        run: |
#          # Create a custom Tutor configuration to add extra pip requirements for the LMS
#          tutor config save --set OPENEDX_EXTRA_PIP_REQUIREMENTS="eox-core\neox-tenant"

#      - name: Rebuild the LMS image to include the extra requirements
#        run: |
#          tutor images build openedx

#      - name: Configure LMS to be externally accessible
#        run: |
#          tutor config save --set LMS_HOST=0.0.0.0

      - name: Start Tutor
        run: |
          tutor local launch -I

      - name: Install additional LMS requirements
        run: |
          tutor local run lms pip install eox-core eox-tenant
          tutor local restart lms

#      - name: Wait for services to be up
#        run: |
#          sleep 600  # Adjust the sleep time as necessary for services to be fully ready

      - name: Get LMS_HOST value
        id: lms_host
        run: |
          echo "LMS_HOST=$(tutor config printvalue LMS_HOST)" >> $GITHUB_ENV

      - name: Check LMS logs
        run: |
          tutor local logs lms --tail=200  # Retrieve the last 100 lines of LMS logs

      - name: Check LMS heartbeat endpoint
        run: |
          curl -f http://LMS:8000/heartbeat
